<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>G.O.A.T Todo App</title>
</head>

<body>
    
    <main class="todo-container">
        <header>
            <h1>Todo List</h1>
        </header>

        <section class="input-group">
            <input type="text" id="todo-input" placeholder="What needs to be done?">
            <button id="add-btn">Add ➕</button>
        </section>

        <ul id="todo-list">
            <li>
                <span>Tasks</span>
                <div class="action-btn-container">
                    <button class="edit-btn">✒️</button>
                    <button class="delete-btn">❌</button>
                </div>
            </li>
        </ul>
    </main>

    <div id="edit-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Edit Task</h3>
            <input type="text" id="edit-input" placeholder="Update your task...">
    
            <div class="modal-actions">
                <button id="cancel-edit-btn" class="modal-btn cancel">Cancel</button>
                <button id="save-edit-btn" class="modal-btn save">Submit</button>
            </div>
        </div>
    </div>

    <script>

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('expiryTime');
            window.location.href='/login.html';
        }
            
        const token = localStorage.getItem('token');
        const expiryTime = localStorage.getItem('expiryTime');
        
        function checkAuth() {
            if(!token || !expiryTime){
                logout();
                return;
            }
            const currentTime = Date.now();
            const timeLeft = expiryTime - currentTime;
            if(timeLeft <= 0){
                alert('Session expired! Please login again.');
                logout();
            } else {
                console.log(`Session is valid!\n Auto-logout in ${Math.floor(timeLeft/1000)} seconds.`);
                setTimeout(()=>{
                    alert('Your session has expired!');
                    logout()
                }, timeLeft);
            }
        }
        
        checkAuth();

        if (!token) {
            window.location.href = './login.html';
        }

        const input = document.getElementById('todo-input');
        const addBtn = document.getElementById('add-btn');
        const list = document.getElementById('todo-list');

        
        window.onload = async () => {
            const response = await fetch('/todos', {
                headers: { 'token': token } // <--- CHANGE #1: Send Token
            });

            // If token is fake or expired, logout
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
                return;
            }

            const todos = await response.json();
            todos.forEach(todo => {
                addTodoToDOM(todo.id, todo.task);
            });
        };
        
        
        addBtn.addEventListener('click', async () => {
            const taskText = input.value;
            if (taskText === '') return alert("Please enter a task!");

            const response = await fetch('/todos', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'token': token 
                },
                body: JSON.stringify({
                    task: taskText,
                    task_completed: false
                })
            });

            
            const savedTodoID = response.json();

            
            addTodoToDOM(savedTodoID.id, taskText);
            input.value = '';
        });


        
        function addTodoToDOM(id, task) {
            const li = document.createElement('li');
            li.id = `todo-${id}`;
            li.innerHTML = `
                <span>${task}</span>
                <div class="action-btn-container">
                    <button class="edit-btn" onclick="editTodo(${id})">✒️</button>
                    <button class="delete-btn" onclick="deleteTodo(${id})">❌</button>                    
                </div>
            `;
            list.appendChild(li);
        }

        
        //  Global Variables for Edit Logic 
            let currentEditId = null;
            const editModal = document.getElementById('edit-modal');
            const editInput = document.getElementById('edit-input');
            const saveBtn = document.getElementById('save-edit-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');

            // 1. The Function triggered by the ✒️ Button 
            function editTodo(id) {
                currentEditId = id; // Remember which ID we are editing

                // Get the current text from the list
                const li = document.getElementById(`todo-${id}`);
                const currentText = li.querySelector('span').innerText;

                // Fill the input and show the modal
                editInput.value = currentText;
                editModal.classList.remove('hidden');
            }

            //  2. The Cancel Button Logic
            cancelBtn.addEventListener('click', () => {
                editModal.classList.add('hidden'); // Just hide the window
                currentEditId = null;
            });

            // 3. The Submit Button Logic
            saveBtn.addEventListener('click', async () => {
                const newTask = editInput.value;

                if (!newTask) return alert("Task cannot be empty!");

                try {
                    // Send PUT request to Backend
                    const response = await fetch(`/todos/${currentEditId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'token': token
                        },
                        body: JSON.stringify({ task: newTask })
                    });

                    if (response.ok) {
                        // Update the UI immediately
                        const li = document.getElementById(`todo-${currentEditId}`);
                        li.querySelector('span').innerText = newTask;

                        // Close the modal
                        editModal.classList.add('hidden');
                        currentEditId = null;
                    } else {
                        alert("Failed to update task!");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Something went wrong.");
                }
            });

        async function deleteTodo(id) {
            await fetch(`/todos/${id}`, {
                method: 'DELETE',
                headers: { 'token': token } // <--- CHANGE #3: Send Token
            });

            document.getElementById(`todo-${id}`).remove();
        }
    
    </script>   


</body>


</html>